---
- name: Install and configure Cpex
  hosts: all
  become: yes
  vars_files:
    - vars.yml
    
  tasks:
    - name: Wait for user data to complete
      tags: 
        - user_data_done
      wait_for:
        path: "{{ user_data_done_file }}"
        state: present
        delay: 5
        timeout: 300
      register: user_data_status

    - name: Debug user data status
      debug:
        var: user_data_status
      tags: 
        - user_data_done

    - name: Clone the repository
      tags:
        - clone_repo
      git:
        repo: "{{ repo_url }}"
        dest: "{{ repo_dest }}"
        version: "{{ repo_branch }}"
        force: yes

    - name: Ensure correct branch is checked out and pull latest changes
      tags:
        - checkout_branch
      git:
        repo: "{{ repo_url }}"
        dest: "{{ repo_dest }}"
        version: "{{ repo_branch }}"
        force: yes
        update: yes

    - name: Build Docker Images
      tags:
        - build_images
      command: "./prototype.sh build cpex"
      args:
        chdir: "{{ repo_dest }}"

    - name: Copy hosts.yml to Node
      tags:
        - copy_hosts
      copy:
        src: "../hosts.yml"
        dest: "{{ repo_dest }}/automation/hosts.yml"

    - name: Duplicate .env.example to .env on the remote
      command: cp .env.example .env
      args:
        chdir: "{{ repo_dest }}"
      tags:
        - copy_env

    - name: Update APP_ENV key in .env
      tags:
        - update_env
      lineinfile:
        path: "{{ repo_dest }}/.env"
        regexp: '^APP_ENV='
        line: "APP_ENV=prod"

    - name: Update TGS_GPK key in .env
      tags:
        - update_env
      lineinfile:
        path: "{{ repo_dest }}/.env"
        regexp: '^TGS_GPK='
        line: "TGS_GPK={{ tgs_gpk_value }}"
    
    - name: Add or update NODE_IP in .env
      lineinfile:
        path: "{{ repo_dest }}/.env"
        regexp: '^NODE_IP='
        line: "NODE_IP={{ hostvars[inventory_hostname].ansible_default_ipv4.address }}"
        create: yes
      tags:
        - update_env


